# PillSnap Stage 3 데이터셋 분석 보고서

**생성일:** 2025-08-22  
**목표:** Stage 3 (100,000 이미지, 1000 클래스) 구성을 위한 데이터 현황 분석  

---

## 📊 현재 데이터 현황

### 전체 데이터셋 규모
- **총 클래스 수:** 4,023개
- **총 이미지 수:** 2,586,498장
- **데이터 위치:**
  - Linux SSD: `/home/max16/pillsnap_data` (3,724개 클래스)
  - Windows SSD: `/mnt/windows/pillsnap_data` (300개 클래스)

### 클래스별 이미지 분포 통계
```
평균 이미지/클래스: 643장
중앙값: 324장
표준편차: 536장
최소: 216장
최대: 2,592장
```

---

## 🎯 Stage 3 구성 전략

### 권장 전략: **적응적 샘플링**

현재 Linux SSD 여유 공간(139GB)을 고려한 최적화 전략:

#### 클래스 계층화
1. **Tier 1 (상위 400개 클래스)**
   - 각 클래스당 150장 샘플링
   - 총 60,000장
   
2. **Tier 2 (중위 400개 클래스)** 
   - 각 클래스당 75장 샘플링
   - 총 30,000장
   
3. **Tier 3 (하위 200개 클래스)**
   - 각 클래스당 50장 샘플링  
   - 총 10,000장

#### 총 구성
- **클래스 수:** 1,000개
- **총 이미지:** 100,000장
- **훈련용:** 80,000장 (80%)
- **검증용:** 20,000장 (20%)
- **예상 용량:** 14.6GB
- **여유 공간 사용률:** 10.5% (매우 안전)

---

## 📈 상위/하위 클래스 분석

### 상위 20개 클래스 (이미지 수 기준)
| 순위 | EDI 코드 | 이미지 수 |
|------|----------|-----------|
| 1    | K-016189 | 2,592장   |
| 2    | K-016204 | 2,592장   |
| 3    | K-016218 | 2,592장   |
| 4    | K-016221 | 2,592장   |
| 5    | K-016232 | 2,592장   |
| ...  | ...      | ...       |
| 20   | K-038220 | 2,592장   |

### 하위 20개 클래스 (이미지 수 기준)
| 순위 | EDI 코드 | 이미지 수 |
|------|----------|-----------|
| 1    | K-016728 | 216장     |
| 2    | K-007639 | 216장     |
| 3    | K-007772 | 216장     |
| ...  | ...      | ...       |
| 20   | K-007705 | 216장     |

---

## 🔍 전략 비교 분석

| 전략 | 이미지 수 | 용량 | 장점 | 단점 |
|------|-----------|------|------|------|
| **균등 분배** | 100,000장 | 14.6GB | 클래스 균형 | 상위 클래스 데이터 손실 |
| **가중 분배** | 96,000장 | 14.1GB | 중요 클래스 강조 | 클래스 불균형 |
| **적응적 샘플링** ⭐ | 100,000장 | 14.6GB | 최적 균형 | - |
| **단계별 확장** | 100,000장 | 80GB+ | 위험 최소화 | 여러 단계 필요 |

---

## 💾 스토리지 요구사항

### 현재 환경
- **Linux SSD 전체:** 3.6TB
- **사용 중:** 3.3TB (97%)
- **사용 가능:** 139GB (3%)
- **Stage 3 필요:** 14.6GB
- **안전 여유율:** 10.5% 사용 (✅ 매우 안전)

### 권장사항
- ✅ **현재 환경에서 Stage 3 실행 가능**
- ✅ **충분한 여유 공간 확보**
- ✅ **디스크 용량 문제 없음**

---

## 🚀 실행 계획

### Phase 1: 데이터 준비
1. **클래스 선별 스크립트 실행**
   ```bash
   cd /home/max16/pillsnap
   python generate_stage3_dataset.py
   ```

2. **데이터 검증**
   - 클래스당 샘플링 수 확인
   - 이미지 품질 검사
   - 디스크 사용량 모니터링

### Phase 2: 데이터셋 구성
1. **훈련/검증 분할 (8:2)**
2. **매니페스트 파일 생성**
3. **데이터 증강 설정**

### Phase 3: 훈련 준비
1. **EfficientNetV2-S 모델 설정**
2. **하이퍼파라미터 튜닝**
3. **RTX 5080 최적화 설정**

---

## 🎯 예상 성능 목표

### Stage 3 목표
- **정확도 목표:** 85% 이상
- **훈련 시간:** 약 3-4시간 (30 epochs)
- **메모리 사용량:** < 14GB VRAM
- **CPU 활용:** num_workers=8 (Native Linux)

### 검증 기준
- **Top-1 정확도:** ≥ 85%
- **Top-5 정확도:** ≥ 95%
- **클래스별 Precision:** ≥ 80%
- **클래스별 Recall:** ≥ 80%

---

## ⚠️ 주의사항 및 제약

### 기술적 제약
1. **클래스 불균형:** Tier 구조로 완화
2. **메모리 제약:** 배치 크기 조정 필요
3. **훈련 시간:** 대용량 데이터셋으로 증가

### 운영상 고려사항
1. **디스크 모니터링:** 실시간 공간 확인
2. **백업 전략:** 중요 체크포인트 보존
3. **로그 관리:** 상세 훈련 로그 수집

---

## 🔄 Stage 4 준비

### Stage 4 대비 계획
- **목표:** 500,000 이미지, 4,523 클래스
- **예상 용량:** ~73GB
- **필요 조치:** M.2 SSD 확장 또는 데이터 압축

### 확장성 고려사항
- Native Linux 환경 최적화 완료
- CPU 멀티프로세싱 최적화 적용
- 하이브리드 스토리지 구조 활용

---

## 📝 실행 명령어 요약

```bash
# 환경 활성화
source .venv/bin/activate

# Stage 3 데이터셋 생성
python generate_stage3_dataset.py

# 훈련 실행
python -m src.training.train_classification_stage --stage 3 --epochs 30 --batch-size 32

# 모니터링
monitor  # 실시간 훈련 상태 확인
status   # 빠른 상태 확인
```

---

**결론:** 현재 환경에서 Stage 3 구성이 완전히 실행 가능하며, 적응적 샘플링 전략을 통해 최적의 성능과 효율성을 달성할 수 있습니다.