<!DOCTYPE html>
<html>
<head>
    <title>ğŸš€ ì‹¤ì‹œê°„ Stage 3 í•™ìŠµ ëª¨ë‹ˆí„°ë§</title>
    <meta charset="utf-8">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background: #1a1a1a; 
            color: #fff; 
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        /* ìƒíƒœ íŒ¨ë„ */
        .status-panel {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .status-card {
            background: #333;
            border-radius: 8px;
            padding: 20px;
            border: 2px solid #555;
        }
        .status-card.running { border-color: #00ff00; }
        .status-card.error { border-color: #ff0000; }
        
        /* ë©”íŠ¸ë¦­ íŒ¨ë„ */
        .metrics-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .metric {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #00ff00;
        }
        .metric-label {
            font-size: 12px;
            color: #aaa;
            margin-top: 5px;
        }
        .metric-change {
            font-size: 10px;
            margin-top: 3px;
        }
        .increasing { color: #ff9900; }
        .decreasing { color: #0099ff; }
        .stable { color: #666; }
        
        /* í•™ìŠµ ì •ë³´ íŒ¨ë„ */
        .training-panel {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .training-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .training-item {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .training-value {
            font-size: 18px;
            font-weight: bold;
            color: #ffff00;
        }
        
        /* ë¡œê·¸ ì»¨í…Œì´ë„ˆ */
        .log-container {
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
        }
        .log-line {
            margin: 2px 0;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .log-line.historical {
            color: #666;
            font-size: 12px;
        }
        .log-line.historical-separator {
            color: #888;
            font-weight: bold;
            background: #1a1a1a;
            border: 1px solid #444;
            text-align: center;
            margin: 5px 0;
        }
        .log-line.session-start {
            color: #00ff00;
            font-weight: bold;
            background: #002200;
            border: 1px solid #004400;
            text-align: center;
            margin: 10px 0;
        }
        .log-line.new {
            color: #00ff00;
            background: #003300;
            animation: flash 0.5s ease-out;
        }
        .log-line.config {
            color: #0099ff;
            background: #001122;
            font-weight: bold;
            border-left: 3px solid #0099ff;
            margin: 3px 0;
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #333;
            color: #fff;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
        }
        .connected { background: #006600; }
        .disconnected { background: #660000; }
        
        @keyframes flash {
            0% { background: #006600; }
            100% { background: #003300; }
        }
        
        .log-container::-webkit-scrollbar { width: 8px; }
        .log-container::-webkit-scrollbar-track { background: #111; }
        .log-container::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        
        .refresh-btn {
            background: #007700;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }
        .refresh-btn:hover { background: #009900; }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">ì—°ê²° ì¤‘...</div>
    
    <div class="container">
        <div class="header">
            <h1>ğŸš€ PillSnap Stage 3 Two-Stage ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</h1>
            <p>ì‹¤ì œ í•™ìŠµ í”„ë¡œì„¸ìŠ¤ ëª¨ë‹ˆí„°ë§ + ì‹¤ì‹œê°„ ë¡œê·¸ ìŠ¤íŠ¸ë¦¬ë°</p>
            <button class="refresh-btn" onclick="location.reload()">ìƒˆë¡œê³ ì¹¨</button>
        </div>
        
        <!-- í”„ë¡œì„¸ìŠ¤ ìƒíƒœ íŒ¨ë„ -->
        <div class="status-panel">
            <div class="status-card" id="processStatus">
                <h3>ğŸ–¥ï¸ í”„ë¡œì„¸ìŠ¤ ìƒíƒœ</h3>
                <div id="processInfo">í™•ì¸ ì¤‘...</div>
            </div>
            <div class="status-card" id="gpuStatus">
                <h3>ğŸ® GPU ìƒíƒœ</h3>
                <div id="gpuInfo">í™•ì¸ ì¤‘...</div>
            </div>
            <div class="status-card" id="timeStatus">
                <h3>â±ï¸ ì‹œê°„ ì •ë³´</h3>
                <div id="timeInfo">í™•ì¸ ì¤‘...</div>
            </div>
        </div>
        
        <!-- ì‹œìŠ¤í…œ ë©”íŠ¸ë¦­ -->
        <div class="metrics-panel" id="metricsPanel">
            <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
        </div>
        
        <!-- í•™ìŠµ ì •ë³´ íŒ¨ë„ -->
        <div class="training-panel">
            <h3>ğŸ¯ í•™ìŠµ ì§„í–‰ ìƒí™©</h3>
            <div class="training-grid" id="trainingGrid">
                <div class="training-item">
                    <div class="training-value" id="currentEpoch">-</div>
                    <div class="metric-label">í˜„ì¬ Epoch</div>
                </div>
                <div class="training-item">
                    <div class="training-value" id="currentBatch">-</div>
                    <div class="metric-label">í˜„ì¬ Batch</div>
                </div>
                <div class="training-item">
                    <div class="training-value" id="clsAccuracy">-</div>
                    <div class="metric-label">Classification Top-1</div>
                </div>
                <div class="training-item">
                    <div class="training-value" id="top5Accuracy">-</div>
                    <div class="metric-label">Classification Top-5</div>
                </div>
                <div class="training-item">
                    <div class="training-value" id="macroF1">-</div>
                    <div class="metric-label">Macro F1 Score</div>
                </div>
                <div class="training-item">
                    <div class="training-value" id="detMap">-</div>
                    <div class="metric-label">Detection mAP</div>
                </div>
                <div class="training-item">
                    <div class="training-value" id="epochTime">-</div>
                    <div class="metric-label">Epoch ì‹œê°„</div>
                </div>
                <div class="training-item">
                    <div class="training-value" id="totalProgress">-</div>
                    <div class="metric-label">ì „ì²´ ì§„í–‰ë¥ </div>
                </div>
            </div>
        </div>
        
        <!-- ë„ë©”ì¸ë³„ ì„±ëŠ¥ íŒ¨ë„ -->
        <div class="training-panel">
            <h3>ğŸ“Š ë„ë©”ì¸ë³„ ì„±ëŠ¥</h3>
            <div class="training-grid" id="domainGrid">
                <div class="training-item">
                    <div class="training-value" id="singleTop1">-</div>
                    <div class="metric-label">Single Top-1</div>
                </div>
                <div class="training-item">
                    <div class="training-value" id="singleTop5">-</div>
                    <div class="metric-label">Single Top-5</div>
                </div>
                <div class="training-item">
                    <div class="training-value" id="singleF1">-</div>
                    <div class="metric-label">Single F1</div>
                </div>
                <div class="training-item">
                    <div class="training-value" id="comboTop1">-</div>
                    <div class="metric-label">Combo Top-1</div>
                </div>
                <div class="training-item">
                    <div class="training-value" id="comboTop5">-</div>
                    <div class="metric-label">Combo Top-5</div>
                </div>
                <div class="training-item">
                    <div class="training-value" id="comboF1">-</div>
                    <div class="metric-label">Combo F1</div>
                </div>
            </div>
        </div>
        
        <!-- ë ˆì´í„´ì‹œ ë° ì‹œìŠ¤í…œ íŒ¨ë„ -->
        <div class="training-panel">
            <h3>âš¡ ë ˆì´í„´ì‹œ & ì‹œìŠ¤í…œ</h3>
            <div class="training-grid" id="latencyGrid">
                <div class="training-item">
                    <div class="training-value" id="detLatency">-</div>
                    <div class="metric-label">Detection</div>
                </div>
                <div class="training-item">
                    <div class="training-value" id="cropLatency">-</div>
                    <div class="metric-label">Crop</div>
                </div>
                <div class="training-item">
                    <div class="training-value" id="clsLatency">-</div>
                    <div class="metric-label">Classification</div>
                </div>
                <div class="training-item">
                    <div class="training-value" id="totalLatency">-</div>
                    <div class="metric-label">Total Pipeline</div>
                </div>
                <div class="training-item">
                    <div class="training-value" id="vramPeak">-</div>
                    <div class="metric-label">VRAM Peak</div>
                </div>
                <div class="training-item">
                    <div class="training-value" id="gradNorm">-</div>
                    <div class="metric-label">Grad Norm</div>
                </div>
            </div>
        </div>
        
        <!-- Detection ë©”íŠ¸ë¦­ íŒ¨ë„ -->
        <div class="training-panel">
            <h3>ğŸ¯ Detection ìƒì„¸</h3>
            <div class="training-grid" id="detectionGrid">
                <div class="training-item">
                    <div class="training-value" id="detRecall">-</div>
                    <div class="metric-label">Recall</div>
                </div>
                <div class="training-item">
                    <div class="training-value" id="detPrecision">-</div>
                    <div class="metric-label">Precision</div>
                </div>
                <div class="training-item">
                    <div class="training-value" id="detConfidence">-</div>
                    <div class="metric-label">Det Confidence</div>
                </div>
                <div class="training-item">
                    <div class="training-value" id="clsConfidence">-</div>
                    <div class="metric-label">Cls Confidence</div>
                </div>
                <div class="training-item">
                    <div class="training-value" id="confSingle">-</div>
                    <div class="metric-label">Single Conf</div>
                </div>
                <div class="training-item">
                    <div class="training-value" id="confCombo">-</div>
                    <div class="metric-label">Combo Conf</div>
                </div>
            </div>
        </div>
        
        <!-- ì‹¤ì‹œê°„ ë¡œê·¸ -->
        <div>
            <h3>ğŸ“‹ ì‹¤ì‹œê°„ í•™ìŠµ ë¡œê·¸</h3>
            <div class="log-container" id="logContainer">
                <div class="log-line">ì‹¤ì‹œê°„ ë¡œê·¸ ì—°ê²° ì¤‘...</div>
            </div>
        </div>
    </div>

    <script>
        let currentData = {};
        let logCount = 0;
        let latestEpoch = 0;
        let latestClsAcc = 0;
        let latestDetMap = 0;
        let totalEpochs = 50; // Stage 3 ê¸°ë³¸ê°’
        let maxBatches = 5093; // ê¸°ë³¸ê°’
        
        // ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function fetchSystemData() {
            try {
                const response = await fetch('/api/system');
                if (response.ok) {
                    currentData = await response.json();
                    updateSystemStatus();
                }
            } catch (error) {
                console.error('ì‹œìŠ¤í…œ ë°ì´í„° ì˜¤ë¥˜:', error);
            }
        }
        
        function updateSystemStatus() {
            if (currentData.status === 'running') {
                // í”„ë¡œì„¸ìŠ¤ ìƒíƒœ
                document.getElementById('processStatus').className = 'status-card running';
                document.getElementById('processInfo').innerHTML = `
                    <strong>PID:</strong> ${currentData.process.pid}<br>
                    <strong>CPU:</strong> ${currentData.process.cpu_percent}%<br>
                    <strong>ë©”ëª¨ë¦¬:</strong> ${currentData.process.memory_gb}GB
                `;
                
                // GPU ìƒíƒœ
                if (currentData.gpu && !currentData.gpu.error) {
                    document.getElementById('gpuInfo').innerHTML = `
                        <strong>ì‚¬ìš©ë¥ :</strong> ${currentData.gpu.utilization}%<br>
                        <strong>ë©”ëª¨ë¦¬:</strong> ${currentData.gpu.memory_used_mb}MB<br>
                        <strong>ì˜¨ë„:</strong> ${currentData.gpu.temperature}Â°C
                    `;
                }
                
                // ì‹œê°„ ì •ë³´
                const runtime = Math.floor(currentData.process.running_time / 60);
                document.getElementById('timeInfo').innerHTML = `
                    <strong>ì‹¤í–‰ ì‹œê°„:</strong> ${runtime}ë¶„<br>
                    <strong>ì—…ë°ì´íŠ¸:</strong> ${new Date(currentData.timestamp).toLocaleTimeString()}
                `;
                
                // ë©”íŠ¸ë¦­ íŒ¨ë„ ì—…ë°ì´íŠ¸
                updateMetricsPanel();
            } else {
                document.getElementById('processStatus').className = 'status-card error';
                document.getElementById('processInfo').textContent = 'í•™ìŠµ í”„ë¡œì„¸ìŠ¤ ì—†ìŒ';
            }
        }
        
        function updateMetricsPanel() {
            const metrics = currentData.changes || {};
            const metricsPanel = document.getElementById('metricsPanel');
            
            let metricsHtml = '';
            
            // ì£¼ìš” ë©”íŠ¸ë¦­ë“¤
            const metricConfigs = [
                { key: 'cpu_percent', label: 'CPU ì‚¬ìš©ë¥ ', value: currentData.process?.cpu_percent, unit: '%' },
                { key: 'memory_gb', label: 'RAM ì‚¬ìš©ëŸ‰', value: currentData.process?.memory_gb, unit: 'GB' },
                { key: 'gpu_util', label: 'GPU ì‚¬ìš©ë¥ ', value: currentData.gpu?.utilization, unit: '%' },
                { key: 'gpu_memory', label: 'GPU ë©”ëª¨ë¦¬', value: currentData.gpu?.memory_used_mb, unit: 'MB' },
                { key: 'gpu_temp', label: 'GPU ì˜¨ë„', value: currentData.gpu?.temperature, unit: 'Â°C' }
            ];
            
            metricConfigs.forEach(config => {
                if (config.value !== undefined) {
                    const change = metrics[config.key];
                    const changeClass = change ? change.trend : 'stable';
                    const changeText = change ? `${change.trend} (${change.change > 0 ? '+' : ''}${change.change})` : '';
                    
                    metricsHtml += `
                        <div class="metric">
                            <div class="metric-value">${config.value}${config.unit}</div>
                            <div class="metric-label">${config.label}</div>
                            <div class="metric-change ${changeClass}">${changeText}</div>
                        </div>
                    `;
                }
            });
            
            metricsPanel.innerHTML = metricsHtml;
        }
        
        function updateTrainingInfo(message) {
            // Epoch ì •ë³´ ì¶”ì¶œ
            const epochMatch = message.match(/Epoch\s+(\d+)/i);
            if (epochMatch) {
                latestEpoch = parseInt(epochMatch[1]);
                document.getElementById('currentEpoch').textContent = latestEpoch;
                
                const progress = Math.round((latestEpoch / totalEpochs) * 100);
                document.getElementById('totalProgress').textContent = `${progress}%`;
            }
            
            // Classification ì •í™•ë„ ì¶”ì¶œ
            const clsMatch = message.match(/Cls Acc:\s*([\d.]+)/i);
            if (clsMatch) {
                latestClsAcc = parseFloat(clsMatch[1]);
                document.getElementById('clsAccuracy').textContent = `${(latestClsAcc * 100).toFixed(1)}%`;
            }
            
            // Detection mAP ì¶”ì¶œ
            const detMatch = message.match(/Det mAP:\s*([\d.]+)/i);
            if (detMatch) {
                latestDetMap = parseFloat(detMatch[1]);
                document.getElementById('detMap').textContent = `${(latestDetMap * 100).toFixed(1)}%`;
            }
            
            // ì‹œê°„ ì •ë³´ ì¶”ì¶œ
            const timeMatch = message.match(/Time:\s*([\d.]+)s/i);
            if (timeMatch) {
                const seconds = parseFloat(timeMatch[1]);
                const minutes = Math.floor(seconds / 60);
                document.getElementById('epochTime').textContent = `${minutes}ë¶„ ${Math.floor(seconds % 60)}ì´ˆ`;
            }
            
            // Batch ì •ë³´ ì¶”ì¶œ
            const batchMatch = message.match(/Batch\s+(\d+)(?:\/(\d+))?/i);
            if (batchMatch) {
                const currentBatch = parseInt(batchMatch[1]);
                const totalBatch = batchMatch[2] ? parseInt(batchMatch[2]) : maxBatches;
                
                if (batchMatch[2]) {
                    maxBatches = totalBatch; // ì´ ë°°ì¹˜ ìˆ˜ ì—…ë°ì´íŠ¸
                }
                
                document.getElementById('currentBatch').textContent = `${currentBatch}/${maxBatches}`;
                
                // ë°°ì¹˜ ì§„í–‰ë¥  ê³„ì‚°
                const batchProgress = Math.round((currentBatch / maxBatches) * 100);
                
                // ì „ì²´ ì§„í–‰ë¥  ê³„ì‚°
                const epochProgress = ((latestEpoch - 1) / totalEpochs) * 100;
                const currentEpochProgress = (batchProgress / totalEpochs);
                const overallProgress = Math.round(epochProgress + currentEpochProgress);
                
                document.getElementById('totalProgress').textContent = `${overallProgress}%`;
            }
        }
        
        // WebSocket ì—°ê²°
        const ws = new WebSocket(`ws://${window.location.host}/ws`);
        
        ws.onopen = function(event) {
            document.getElementById('connectionStatus').textContent = 'âœ… ë¡œê·¸ ì—°ê²°ë¨';
            document.getElementById('connectionStatus').className = 'connection-status connected';
        };
        
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            const logLine = document.createElement('div');
            
            if (data.type === 'session_start') {
                logLine.className = 'log-line session-start';
                logContainer.innerHTML = '';
            } else if (data.type === 'new_training_start') {
                logLine.className = 'log-line session-start';
                logContainer.innerHTML = '<div class="log-line historical-separator">--- ì´ì „ ì„¸ì…˜ ì¢…ë£Œ ---</div>';
            } else if (data.type === 'historical_header' || data.type === 'historical_footer') {
                logLine.className = 'log-line historical-separator';
            } else if (data.historical) {
                logLine.className = 'log-line historical';
            } else {
                logLine.className = 'log-line new';
            }
            
            logLine.textContent = data.message;
            
            // ìƒˆë¡œìš´ ë©”íŠ¸ë¦­ë“¤ ì—…ë°ì´íŠ¸
            if (data.type === 'realtime') {
                // ê¸°ë³¸ ë©”íŠ¸ë¦­
                if (data.top1_accuracy_norm) document.getElementById('clsAccuracy').textContent = data.top1_accuracy_norm;
                if (data.top5_accuracy_norm) document.getElementById('top5Accuracy').textContent = data.top5_accuracy_norm;
                if (data.macro_f1_norm) document.getElementById('macroF1').textContent = data.macro_f1_norm;
                if (data.det_map && data.det_map !== "N/A") {
                    const detMapVal = parseFloat(data.det_map);
                    document.getElementById('detMap').textContent = `${(detMapVal * 100).toFixed(1)}%`;
                }
                
                // ë„ë©”ì¸ë³„ ë©”íŠ¸ë¦­
                if (data.single_top1_norm) document.getElementById('singleTop1').textContent = data.single_top1_norm;
                if (data.single_top5_norm) document.getElementById('singleTop5').textContent = data.single_top5_norm;
                if (data.single_macro_f1_norm) document.getElementById('singleF1').textContent = data.single_macro_f1_norm;
                if (data.combo_top1_norm) document.getElementById('comboTop1').textContent = data.combo_top1_norm;
                if (data.combo_top5_norm) document.getElementById('comboTop5').textContent = data.combo_top5_norm;
                if (data.combo_macro_f1_norm) document.getElementById('comboF1').textContent = data.combo_macro_f1_norm;
                
                // ë ˆì´í„´ì‹œ ë©”íŠ¸ë¦­
                if (data.det_latency_norm) document.getElementById('detLatency').textContent = data.det_latency_norm;
                if (data.crop_latency_norm) document.getElementById('cropLatency').textContent = data.crop_latency_norm;
                if (data.cls_latency_norm) document.getElementById('clsLatency').textContent = data.cls_latency_norm;
                if (data.total_latency_norm) document.getElementById('totalLatency').textContent = data.total_latency_norm;
                
                // ì‹œìŠ¤í…œ ë©”íŠ¸ë¦­
                if (data.vram_peak_mb_norm) document.getElementById('vramPeak').textContent = data.vram_peak_mb_norm;
                if (data.grad_norm_after_norm) document.getElementById('gradNorm').textContent = data.grad_norm_after_norm;
                
                // Detection ë©”íŠ¸ë¦­
                if (data.det_recall_norm) document.getElementById('detRecall').textContent = data.det_recall_norm;
                if (data.det_precision_norm) document.getElementById('detPrecision').textContent = data.det_precision_norm;
                if (data.det_confidence_norm) document.getElementById('detConfidence').textContent = data.det_confidence_norm;
                if (data.cls_confidence_norm) document.getElementById('clsConfidence').textContent = data.cls_confidence_norm;
                if (data.selected_conf_single) document.getElementById('confSingle').textContent = data.selected_conf_single;
                if (data.selected_conf_combo) document.getElementById('confCombo').textContent = data.selected_conf_combo;
                
                // Epoch/Batch ì •ë³´
                if (data.epoch) document.getElementById('currentEpoch').textContent = data.epoch;
                if (data.batch) document.getElementById('currentBatch').textContent = data.batch;
                if (data.epoch_time) document.getElementById('epochTime').textContent = data.epoch_time;
                
                // ì§„í–‰ë¥  ê³„ì‚°
                if (data.total_epochs && data.epoch) {
                    const progress = Math.round((data.epoch / data.total_epochs) * 100);
                    document.getElementById('totalProgress').textContent = `${progress}%`;
                }
            }
            
            // ê¸°ì¡´ í•™ìŠµ ì •ë³´ ì—…ë°ì´íŠ¸ë„ ìœ ì§€
            updateTrainingInfo(data.message);
            
            document.getElementById('logContainer').appendChild(logLine);
            document.getElementById('logContainer').scrollTop = document.getElementById('logContainer').scrollHeight;
            
            // ë¡œê·¸ ê°œìˆ˜ ì œí•œ
            logCount++;
            if (logCount > 1000) {
                const firstChild = document.getElementById('logContainer').firstChild;
                if (firstChild) {
                    document.getElementById('logContainer').removeChild(firstChild);
                    logCount--;
                }
            }
        };
        
        ws.onclose = function(event) {
            document.getElementById('connectionStatus').textContent = 'âŒ ë¡œê·¸ ì—°ê²° ëŠê¹€';
            document.getElementById('connectionStatus').className = 'connection-status disconnected';
        };
        
        // ì‹œìŠ¤í…œ ë°ì´í„° ì£¼ê¸°ì  ì—…ë°ì´íŠ¸ (1ì´ˆë§ˆë‹¤)
        setInterval(fetchSystemData, 1000);
        fetchSystemData(); // ì¦‰ì‹œ ì²« ì—…ë°ì´íŠ¸
    </script>
</body>
</html>